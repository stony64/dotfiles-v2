#!/usr/bin/env bash
#
# ┌───────────────────────────────────────────────────────────────────────────┐
# │ FILE: home/.bashenv                                                       │
# │ ZWECK: Zentrale Umgebungsvariablen, Pfade und Shell-Optionen              │
# │ STANDARDS: Bash >= 4.0, Google Shell Style Guide                          │
# └───────────────────────────────────────────────────────────────────────────┘

# ──────────────────────────────────────────────────────────────
# 1. PLATTFORM-ERKENNUNG & BIBLIOTHEKEN
# ──────────────────────────────────────────────────────────────

case "$(uname -s)" in
    Linux*)  export PLATFORM="linux" ;;
    MSYS*|MINGW*|CYGWIN*) export PLATFORM="windows" ;;
    *)       export PLATFORM="unknown" ;;
esac

# Auflösung der Repository-Pfade für konsistente Farben
DOT_REPO="${DOTFILES_REPO_PATH:-$HOME/.dotfiles}"

# Laden der UI-Konstanten (falls vorhanden)
if [[ -f "${DOT_REPO}/lib/libcolors.sh" ]] && [[ -f "${DOT_REPO}/lib/libconstants.sh" ]]; then
    # shellcheck disable=SC1091
    source "${DOT_REPO}/lib/libcolors.sh"
    # shellcheck disable=SC1091
    source "${DOT_REPO}/lib/libconstants.sh"
fi

# ──────────────────────────────────────────────────────────────
# 2. SYSTEM-PFADE (PATH)
# ──────────────────────────────────────────────────────────────

# Lokale Binaries priorisieren
[[ -d "$HOME/bin" ]] && PATH="$HOME/bin:$PATH"
[[ -d "$HOME/.local/bin" ]] && PATH="$HOME/.local/bin:$PATH"
export PATH

# ──────────────────────────────────────────────────────────────
# 3. BASH HISTORY & PERFORMANCE
# ──────────────────────────────────────────────────────────────

export HISTCONTROL="ignoreboth:erasedups"
export HISTIGNORE="la:ll:lah:ls:cd ..:exit:mc:history:clear"
export HISTSIZE="${HIST_SIZE_INTERNAL:-8192}"
export HISTFILESIZE="${HIST_FILE_SIZE_INTERNAL:-16384}"

# Shell-Optionen für besseres Handling
shopt -s histappend   # History erweitern statt überschreiben
shopt -s cmdhist      # Mehrzeilige Befehle konsolidieren
shopt -s cdspell      # Tippfehler-Korrektur für 'cd'
shopt -s checkwinsize # Terminal-Größe nach jedem Befehl prüfen
shopt -s globstar     # Rekursives Wildcard-Matching (**/*.sh)

# ──────────────────────────────────────────────────────────────
# 4. MANPAGES IN FARBE (LESS_TERMCAP)
# ──────────────────────────────────────────────────────────────
# Nutzt die atomaren UI-Variablen aus libcolors.sh/libconstants.sh

if [[ "${PLATFORM:-}" == "linux" ]]; then
    export MANPAGER="less -s -M +Gg"

    # Start-Sequenzen (md: Fett/Gelb, us: Unterstrichen/Grün, so: Standout/Status)
    export LESS_TERMCAP_mb="${UI_ESC_START:-}${UI_COL_RED:-}${UI_ESC_END:-}"
    export LESS_TERMCAP_md="${UI_ESC_START:-}${UI_ATTR_BOLD:-};${UI_COL_YELLOW:-}${UI_ESC_END:-}"
    export LESS_TERMCAP_us="${UI_ESC_START:-}${UI_ATTR_UNDERLINE:-};${UI_COL_GREEN:-}${UI_ESC_END:-}"
    export LESS_TERMCAP_so="${UI_ESC_START:-}${UI_ATTR_BOLD:-};${UI_BG_BLUE:-};${UI_COL_YELLOW:-}${UI_ESC_END:-}"

    # Reset-Sequenzen
    export LESS_TERMCAP_me="${UI_COL_RESET:-}"
    export LESS_TERMCAP_se="${UI_COL_RESET:-}"
    export LESS_TERMCAP_ue="${UI_COL_RESET:-}"
fi

# ──────────────────────────────────────────────────────────────
# 5. SSH & LOCALES
# ──────────────────────────────────────────────────────────────

if [[ -n "${SSH_CONNECTION:-}" ]]; then
    export TMOUT=0 # Verhindert Auto-Logout in Remote-Sitzungen
fi

# Fix für UTF-8 (v1.2.1 Standard)
export LC_ALL=C.UTF-8
export LANG=C.UTF-8

# ──────────────────────────────────────────────────────────────
# 6. TOOL-KONFIGURATION (DIRCOLORS / FZF)
# ──────────────────────────────────────────────────────────────

# Dircolors für LS_COLORS
if [[ "${PLATFORM:-}" == "linux" ]]; then
    if [[ -f "$HOME/.dircolors" ]]; then
        eval "$(dircolors -b "$HOME/.dircolors")"
    fi
fi

# FZF-Integration
if [[ -f "$HOME/.fzf.bash" ]]; then
    # shellcheck disable=SC1091
    source "$HOME/.fzf.bash"
fi

# ──────────────────────────────────────────────────────────────
# 7. HOST-SPEZIFISCHE ANPASSUNGEN & LOCALES
# ──────────────────────────────────────────────────────────────

if [[ "${PLATFORM:-}" == "linux" ]]; then
    case "$(hostname)" in
        raspifix) [[ -d "/opt/script" ]] && PATH="$PATH:/opt/script" ;;
        proxmox*) [[ -d "/opt/scripts" ]] && PATH="$PATH:/opt/scripts" ;;
    esac
fi

# Lokale Overrides (Letztes Wort für das lokale System)
[[ -f "$HOME/.bash_env_local" ]] && source "$HOME/.bash_env_local"

true
