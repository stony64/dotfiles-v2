#!/usr/bin/env bash
#
# FILE: home/.bashprompt
# ──────────────────────────────────────────────────────────────
# KONFIGURATION DES SHELL-PROMPTS (PS1)
# ──────────────────────────────────────────────────────────────
# Zweck:    Visuelle Darstellung der Befehlszeile mit Status-Infos
#           zu User, Host, Verzeichnis und Git-Branch.
# Abhängigkeiten: .bashenv, libcolors.sh.
# ──────────────────────────────────────────────────────────────

# @section 1. Git-Status Integration
# Extrahiert den aktuellen Branch-Namen, falls man sich in einem Repo befindet.
# @stdout Formatiert "(branch)" in Gelb oder nichts.
__bash_prompt_git_branch() {
    local branch
    # v1.2.1 Sync: Nutzung der UI_COL_ Variablen
    if branch=$(git symbolic-ref --short HEAD 2>/dev/null); then
        echo -e " ${UI_COL_YELLOW}(${branch})${UI_COL_RESET}"
    elif branch=$(git rev-parse --short HEAD 2>/dev/null); then
        echo -e " ${UI_COL_YELLOW}(${branch:0:7}...)${UI_COL_RESET}"
    fi
}

# @section 2. Prompt-Konstruktion (PS1)
# Setzt die PS1-Variable basierend auf der Plattform und dem User-Status.
# Formatelemente:
# \u : Benutzername
# \h : Hostname (kurz)
# \w : Aktueller Pfad (komplett, mit ~ für Home)
# \$ : # für Root, $ für User
set_bash_prompt() {
    local user_color host_color path_color prompt_char_color reset

    # WICHTIG: ESC-Sequenzen müssen für PS1 in \[ \] eingeschlossen werden
    reset="\[${UI_COL_RESET}\]"

    # Farbwahl basierend auf User-Rechten
    if [[ "$EUID" -eq 0 ]]; then
        user_color="\[${UI_COL_RED}\]"    # Warnfarbe für Root
    else
        user_color="\[${UI_COL_GREEN}\]"  # Standard für User
    fi

    # Plattformspezifische Akzente
    if [[ "${PLATFORM:-unknown}" == "windows" ]]; then
        host_color="\[${UI_COL_CYAN}\]"
    else
        host_color="\[${UI_COL_BLUE}\]"
    fi

    path_color="\[${UI_COL_MAGENTA}\]"
    prompt_char_color="\[${UI_COL_WHITE}\]"

    # Zusammensetzung des Prompts:
    # [User@Host:Path] (git-branch) $
    PS1="${user_color}\u${reset}"                   # User
    PS1+="\[${UI_COL_WHITE}\]@${reset}"             # @
    PS1+="${host_color}\h${reset}"                  # Host
    PS1+="\[${UI_COL_WHITE}\]:${reset}"             # :
    PS1+="${path_color}\w${reset}"                  # Path

    # Git-Integration (dynamischer Funktionsaufruf)
    # Die Escaping-Logik \$ sorgt dafür, dass die Funktion bei jedem Prompt-Rendern neu ausgeführt wird
    PS1+="\$(__bash_prompt_git_branch)"

    PS1+="\n"                                       # Neue Zeile
    PS1+="${prompt_char_color}\$ ${reset}"          # Prompt-Zeichen
}

# @section 3. Ausführung
# Initialisierung des Prompts beim Laden der Datei.
set_bash_prompt

# @section 4. Terminal-Titel (Xterm/Window-Title)
# Setzt den Titel des Terminal-Fensters auf [User@Host: Path]
case "$TERM" in
    xterm*|rxvt*)
        PS1="\[\e]0;\u@\h: \w\a\]$PS1"
        ;;
esac

true
